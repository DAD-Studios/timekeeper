<%= form_with(model: invoice, data: { controller: "invoice-form" }) do |form| %>
  <% if invoice.errors.any? %>
    <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem;">
      <strong><%= pluralize(invoice.errors.count, "error") %> prohibited this invoice from being saved:</strong>
      <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
        <% invoice.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="card" style="margin-bottom: 1.5rem;">
    <h2 style="margin-bottom: 1rem;">Invoice Details</h2>

    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
      <div>
        <%= form.label :client_id, "Client" %>
        <%= form.collection_select :client_id, @clients, :id, :name,
            { prompt: "Select a client" },
            { data: { action: "change->invoice-form#loadTimeEntries" } } %>
      </div>

      <div>
        <%= form.label :status %>
        <%= form.select :status, Invoice.statuses.keys.map { |s| [s.titleize, s] }, {}, { disabled: invoice.paid? } %>
        <% if invoice.paid? %>
          <small style="display: block; color: #856404; margin-top: 0.25rem;">Cannot change status of paid invoice</small>
        <% end %>
      </div>

      <div>
        <%= form.label :invoice_date %>
        <%= form.date_field :invoice_date, value: invoice.invoice_date || Date.current %>
      </div>

      <div>
        <%= form.label :due_date %>
        <%= form.date_field :due_date, value: invoice.due_date || (Date.current + 30.days) %>
      </div>

      <div>
        <%= form.label :discount_amount %>
        <%= form.number_field :discount_amount, step: 0.01, value: invoice.discount_amount || 0 %>
      </div>
    </div>
  </div>

  <!-- Unbilled Time Entries Section -->
  <div class="card" style="display: none; margin-bottom: 1.5rem;" data-invoice-form-target="timeEntriesSection">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h2 style="margin: 0;">Select Time Entries</h2>
      <button type="button"
              data-action="click->invoice-form#selectAll"
              class="btn btn-secondary"
              style="padding: 0.5rem 1rem; font-size: 14px;">
        <i class="bi bi-check-all"></i> Select All
      </button>
    </div>
    <div style="background: #e8f4fd; border-left: 4px solid #2196F3; padding: 0.75rem 1rem; margin-bottom: 1rem; font-size: 14px;">
      <i class="bi bi-info-circle"></i> Select the time entries to include in this invoice. They will be automatically added as line items below.
    </div>
    <div data-invoice-form-target="timeEntriesList">
      <!-- Time entries will be loaded here via Stimulus -->
    </div>
  </div>

  <div class="card" style="margin-bottom: 1.5rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h2 style="margin: 0;">Line Items</h2>
      <button type="button"
              data-action="click->invoice-form#addLineItem"
              class="btn btn-secondary"
              style="padding: 0.5rem 1rem; font-size: 14px;">
        <i class="bi bi-plus-circle"></i> Add Manual Line Item
      </button>
    </div>

    <div id="manual-line-items" data-invoice-form-target="manualLineItems">
      <%= form.fields_for :line_items do |line_item_form| %>
        <%= render 'line_item_fields', f: line_item_form %>
      <% end %>
    </div>

    <div data-invoice-form-target="emptyState" style="text-align: center; padding: 3rem 1rem; color: #95a5a6;">
      <i class="bi bi-receipt" style="font-size: 48px; display: block; margin-bottom: 1rem;"></i>
      <p style="font-size: 16px; margin: 0;">No line items yet. Select time entries above or add manual line items.</p>
    </div>
  </div>

  <div class="card" style="margin-bottom: 1.5rem;">
    <h2 style="margin-bottom: 1rem;">Additional Information</h2>

    <div style="margin-bottom: 1rem;">
      <%= form.label :notes %>
      <%= form.rich_text_area :notes %>
    </div>

    <div>
      <%= form.label :payment_instructions %>
      <%= form.rich_text_area :payment_instructions %>
    </div>
  </div>

  <div style="display: flex; gap: 1rem;">
    <%= form.submit invoice.new_record? ? "Create Invoice" : "Update Invoice", class: "btn" %>
    <%= link_to "Cancel", invoices_path, class: "btn btn-secondary" %>
  </div>
<% end %>

<template id="line-item-template">
  <div class="line-item-row" style="display: grid; grid-template-columns: 3fr 1fr 1fr 1fr auto; gap: 1rem; align-items: end; padding: 1rem; border: 1px solid #e1e8ed; border-radius: 4px; margin-bottom: 1rem; background: white;">
    <div>
      <label style="display: block; font-weight: 500; margin-bottom: 0.25rem; font-size: 14px;">Description</label>
      <input type="text" name="invoice[line_items_attributes][INDEX][description]" style="width: 100%;">
    </div>

    <div>
      <label style="display: block; font-weight: 500; margin-bottom: 0.25rem; font-size: 14px;">Hours</label>
      <input type="number" step="0.01" name="invoice[line_items_attributes][INDEX][quantity]" class="line-item-quantity" style="width: 100%;">
    </div>

    <div>
      <label style="display: block; font-weight: 500; margin-bottom: 0.25rem; font-size: 14px;">Rate</label>
      <input type="number" step="0.01" name="invoice[line_items_attributes][INDEX][rate]" class="line-item-rate" style="width: 100%;">
    </div>

    <div>
      <label style="display: block; font-weight: 500; margin-bottom: 0.25rem; font-size: 14px;">Amount</label>
      <div style="padding: 0.5rem; background: #f5f7fa; border-radius: 4px; font-weight: 600; color: #5cb85c;">
        <span class="line-item-amount">$0.00</span>
      </div>
    </div>

    <div>
      <button type="button" class="remove-line-item" style="background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 14px; white-space: nowrap;" title="Remove">
        <i class="bi bi-trash"></i>
      </button>
    </div>
  </div>
</template>
